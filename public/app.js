const getDinoData = () => Promise.resolve({
    "Dinos": [
        {
            "species": "Triceratops",
            "weight": 13000,
            "height": 114,
            "diet": "herbavor",
            "where": "North America",
            "when": "Late Cretaceous",
            "facts": [
                "is a genus of herbivorous chasmosaurine ceratopsid dinosaur that first appeared during the late Maastrichtian stage of the Late Cretaceous period, about 68 million years ago in what is now North America",
                "it's one of the last-known non-avian dinosaur genera, and became extinct in the Cretaceous–Paleogene extinction event 66 million years ago",
                "bearing a large bony frill, three horns on the skull, and a large four-legged body, exhibiting convergent evolution with bovines and rhinoceroses, Triceratops is one of the most recognizable of all dinosaurs and the most well-known ceratopsid",
                "it shared the landscape with and was most likely preyed upon by Tyrannosaurus, though it is less certain that two adults did battle in the fanciful manner often depicted in museum displays and popular images",
                "the functions of the frills and three distinctive facial horns on its head have long inspired debate",
                "it was traditionally placed within the \"short-frilled\" ceratopsids, but modern cladistic studies show it to be a member of the Chasmosaurinae which usually have long frills"
            ]
        },
        {
            "species": "Tyrannosaurus Rex",
            "weight": 11905,
            "height": 144,
            "diet": "carnivor",
            "where": "North America",
            "when": "Late Cretaceous",
            "facts": [
                "is a genus of large theropod dinosaur",
                "is one of the best represented theropods",
                "it lived throughout what is now western North America, on what was then an island continent known as Laramidia",
                "fossils are found in a variety of rock formations dating to the Maastrichtian age of the Upper Cretaceous period, 68 to 66 million years ago",
                "it was the last known member of the tyrannosaurids and among the last non-avian dinosaurs to exist before the Cretaceous–Paleogene extinction event",
                "like other tyrannosaurids, Tyrannosaurus was a bipedal carnivore with a massive skull balanced by a long, heavy tail"
            ]
        },
        {
            "species": "Anklyosaurus",
            "weight": 10500,
            "height": 55,
            "diet": "herbavor",
            "where": "North America",
            "when": "Late Cretaceous",
            "facts": [
                "is a genus of armored dinosaur",
                "it's fossils have been found in geological formations dating to the very end of the Cretaceous Period (68–66 million years ago), in western North America",
                "The generic name means \"fused\" or \"bent lizard\", and the specific name means \"great belly\"",
                "a handful of specimens have been excavated to date, but a complete skeleton has not been discovered",
                "though other members of Ankylosauria are represented by more extensive fossil material, Ankylosaurus is often considered the archetypal member of its group",
                "is a member of the family Ankylosauridae, and its closest relatives appear to be Anodontosaurus and Euoplocephalus"
            ]
        },
        {
            "species": "Brachiosaurus",
            "weight": 70000,
            "height": "372",
            "diet": "herbavor",
            "where": "North America",
            "when": "Late Jurasic",
            "facts": [
                "is a genus of sauropod dinosaur that lived in North America during the Late Jurassic, (about 154 to 150 million years ago)",
                "it was first described by American paleontologist Elmer S. Riggs in 1903 from fossils found in the Colorado River valley in western Colorado, United States",
                "it had a disproportionately long neck, small skull, and large overall size, all of which are typical for sauropods",
                "atypically, Brachiosaurus had longer forelimbs than hindlimbs, which resulted in a steeply inclined trunk, and a proportionally shorter tail",
                "most popular depictions of Brachiosaurus are in fact based on Giraffatitan, a genus of brachiosaurid dinosaur from the Tendaguru Formation of Tanzania",
                "It has been used as an example of a dinosaur that was most likely ectothermic because of its large size and the corresponding need for sufficient forage, but more recent research suggests it was warm-blooded"
            ]
        },
        {
            "species": "Stegosaurus",
            "weight": 11600,
            "height": 79,
            "diet": "herbavor",
            "where": "North America, Europe, Asia",
            "when": "Late Jurasic to Early Cretaceous",
            "facts": [
                "is a genus of herbivorous, four-legged, armored dinosaur from the Late Jurassic, characterized by the distinctive kite-shaped upright plates along their backs and spikes on their tails",
                "fossils of the genus have been found in the western United States and in Portugal, where they are found in Kimmeridgian- to Tithonian-aged strata, dating to between 155 and 145 million years ago",
                "it would have lived alongside dinosaurs such as Apatosaurus, Diplodocus, Camarasaurus and Allosaurus, the latter of which may have preyed on it",
                "they're large, heavily built, herbivorous quadrupeds with rounded backs, short fore limbs, long hind limbs, and tails held high in the air",
                "due to their distinctive combination of broad, upright plates and tail tipped with spikes, Stegosaurus is one of the most recognizable kinds of dinosaurs",
                "today, it's generally agreed that their spiked tails were most likely used for defense against predators, while their plates may have been used primarily for display, and secondarily for thermoregulatory functions"
            ]
        },
        {
            "species": "Elasmosaurus",
            "weight": 16000,
            "height": 59,
            "diet": "carnivor",
            "where": "North America",
            "when": "Late Cretaceous",
            "facts": [
                "is a genus of plesiosaur that lived in North America during the Campanian stage of the Late Cretaceous period (about 80.5 million years ago)",
                "the first specimen was discovered in 1867 near Fort Wallace, Kansas, US",
                "the generic name means \"thin-plate reptile\", and the specific name means \"flat-tailed\"",
                "it would have had a streamlined body with paddle-like limbs, a short tail, a small head, and an extremely long neck",
                "along with its relative Albertonectes, it was one of the longest-necked animals to have lived",
                "the skull would have been slender and triangular, with large, fang-like teeth at the front, and smaller teeth towards the back"
            ]
        },
        {
            "species": "Pteranodon",
            "weight": 44,
            "height": 20,
            "diet": "carnivor",
            "where": "North America",
            "when": "Late Cretaceous",
            "facts": [
                "is a genus of pterosaur that included some of the largest known flying reptiles",
                "they lived during the late Cretaceous geological period of North America in present-day Kansas, Nebraska, Wyoming, South Dakota and Alabama",
                "by definition, all dinosaurs belong to the group Dinosauria; Pteranodon belongs to the group Pterosauria",
                "is the most famous pterosaur, frequently featured in dinosaur media and strongly associated with dinosaurs by the general public",
                "pterosaurs such as Pteranodon form a clade closely related to dinosaurs as both fall within the clade Avemetatarsalia",
                "it was the first pterosaur found outside of Europe"
            ]
        },
        {
            "species": "Pigeon",
            "weight": 0.5,
            "height": 9,
            "diet": "herbavor",
            "where": "World Wide",
            "when": "Holocene",
            "facts": [
                "All birds are Dinosaurs"
            ]
        }
    ]
});

const convertInchesToFoot = (inches) => {
    const conversion = inches && parseFloat(inches * 0.0833333);
    return conversion && conversion > 0 ? conversion : 0;
}

const convertFootToInches = (foot) => {
    const conversion = foot && parseFloat(foot * 12);
    return conversion && conversion > 0 ? conversion : 0;
};

const shuffle = (arr = []) => {
    const max = arr.length * 2;
    return arr
        .reduce((acc, next) => {
            const index = Math.random();
            return [...acc, { i: acc.find(({ i }) => index !== i) ? index : index + max, next }];
        }, [])
        .sort((a, b) => a.i - b.i)
        .map(({ next }) => next);
};

const animalDescriptionFactory = (() => {
    const compare = ({ species, otherAnimals = [], topic }) => otherAnimals
        .slice(otherAnimals.findIndex(({ species: lookaheadSpecies }) => species === lookaheadSpecies), otherAnimals.length)
        .filter(({ species: lookaheadSpecies }) => species !== lookaheadSpecies)
        .map(({ species }) => species)
        .reduce((acc, next) => Object.assign({}, acc, { species: [...acc.species, next] }), { topic, species: [] });

    const describe = ({ animal: { feet, inches, lbs, diet } = {} }) => ({
        species: [
            `height: ${feet} ft. (${inches} inches)`,
            `weight: ${lbs} lbs`,
            `diet: ${diet}`
        ],
        topic: "description"
    });

    const tallerThanComparison = ({
        species,
        otherAnimals
    }) => compare({ species, otherAnimals: otherAnimals.sort((a, b) => b.feet - a.feet), topic: "taller than" });

    const sameDietThanComparison = (({ species, otherAnimals }) => {
        const { diet } = otherAnimals.find(({ species: lookaheadSpecies }) => species === lookaheadSpecies);
        return otherAnimals
            .filter((({ diet: lookaheadDiet, species: lookaheadSpecies }) => diet.toLowerCase() === lookaheadDiet.toLowerCase() && species !== lookaheadSpecies))
            .map(({ species }) => species)
            .reduce((acc, next) => Object.assign({}, acc, { species: [...acc.species, next] }), { topic: "same diet", species: [] });
    });

    const heavierThanComparison = ({
        species,
        otherAnimals
    }) => compare({ species, otherAnimals: otherAnimals.sort((a, b) => b.lbs - a.lbs), topic: "heavier than" });

    const getDescription = ({ animal, otherAnimals = [] }) => ([
        describe({ animal }),
        tallerThanComparison({ i: 1, species: animal.species, otherAnimals }),
        heavierThanComparison({ i: 2, species: animal.species, otherAnimals }),
        sameDietThanComparison({ i: 3, species: animal.species, otherAnimals })
    ]);

    return { getDescription };
})();

const HUMAN_CONFIG = { species: "Human", config: { color: 'rgba(106, 125, 204, 0.5)', filename: 'human.png' } };

const DINOSAUR_CONFIGS = [
    { species: "Triceratops", config: { color: 'rgba(5, 155, 140, 0.8)', filename: 'triceratops.png' } },
    { species: "Tyrannosaurus Rex", config: { color: 'rgba(222, 124, 95, 0.8)', filename: 'tyrannosaurus rex.png' } },
    { species: "Anklyosaurus", config: { color: 'rgba(79, 181, 194, 0.8)', filename: 'anklyosaurus.png' } },
    { species: "Brachiosaurus", config: { color: 'rgba(245, 188, 103, 0.8)', filename: 'brachiosaurus.png' } },
    { species: "Stegosaurus", config: { color: 'rgba(107, 170, 106, 0.8)', filename: 'stegosaurus.png' } },
    { species: "Elasmosaurus", config: { color: 'rgba(187, 70, 108, 0.8)', filename: 'elasmosaurus.png' } },
    { species: "Pteranodon", config: { color: 'rgba(129, 102, 181, 0.8)', filename: 'pteranodon.png' } },
    { species: "Pigeon", config: { color: 'rgba(129, 102, 181, 0.8)', filename: 'pigeon.png' } },
];

function Tile(name, fact, color, imageUrl, comparisons = []) {
    this.name = name;
    this.fact = fact;
    this.color = color;
    this.imageUrl = imageUrl;
    this.comparisons = comparisons;
}

function Animal(species, facts, inches, lbs, diet) {
    this.species = species;
    this.facts = facts;
    this.inches = inches;
    this.feet = convertInchesToFoot(inches);
    this.lbs = lbs;
    this.diet = diet;
}

Animal.prototype.getFact = function () {
    const [selectedFact] = shuffle(this.facts);
    return selectedFact;
}

function Dinosaur(species, facts, inches, weight, diet) {
    Animal.call(this, species, facts, inches, weight, diet);
}

Dinosaur.prototype = Object.create(Animal.prototype);
Dinosaur.prototype.constructor = Dinosaur;

Dinosaur.prototype.getSpecies = function () {
    return this.species;
}

function Human(species, facts, inches, weight, diet, name) {
    Animal.call(this, species, facts, inches, weight, diet);
    this.name = name;
}

Human.prototype = Object.create(Animal.prototype);
Human.prototype.constructor = Human;

const tileFactory = (() => {
    const compile = ({ comparisons = [] }) => comparisons.reduce((acc, next) => {
        const { topic, species = [] } = next;
        const text = 0 === species.length ? 'no other' : species.join(", ");
        return `${acc}<span style="text-transform: uppercase;">[${topic}]:</span><br><span style="font-weight: 400">${text}</span><br><br>`;
    }, '');

    const create = ({ imageUrl, name, color, fact, comparisons = [] }) => {
        const dinosaurContainerEl = document.createElement("div");
        const dinosaurDataContainerEl = document.createElement("div");
        dinosaurDataContainerEl.classList = ['dinosaur-data-container'];
        const dataContainerText = compile({ comparisons });
        dinosaurDataContainerEl.innerHTML = dataContainerText;
        dinosaurContainerEl.classList = ['dinosaur-container'];
        dinosaurContainerEl.style.backgroundColor = color;
        const dinosaurNameContainerEl = document.createElement("div");
        dinosaurNameContainerEl.classList = ['dinosaur-name-container'];
        const dinosaurNameEl = document.createElement("dinosaur-name");
        dinosaurNameEl.classList = ["dinosaur-name"];
        dinosaurNameEl.textContent = name;
        const dinosaurImageContainerEl = document.createElement("div");
        dinosaurImageContainerEl.classList = ["dinosaur-img-container"];
        const dinosaurImageEl = document.createElement("div");
        dinosaurImageEl.classList = ["dinosaur-img"];
        const imageEl = document.createElement("img");
        imageEl.classList = ["dinosaur"];
        imageEl.setAttribute("src", `./${imageUrl}`);
        imageEl.setAttribute("alt", "");
        imageEl.setAttribute("srcset", "");
        imageEl.setAttribute("width", "380px");
        imageEl.setAttribute("height", "220px");
        dinosaurNameContainerEl.appendChild(dinosaurNameEl);
        dinosaurImageEl.appendChild(imageEl);
        dinosaurImageContainerEl.appendChild(dinosaurImageEl);

        dinosaurContainerEl.appendChild(dinosaurDataContainerEl);
        dinosaurContainerEl.appendChild(dinosaurNameContainerEl);
        dinosaurContainerEl.appendChild(dinosaurImageContainerEl);

        if (fact) {
            const factContainerEl = document.createElement("div");
            factContainerEl.classList = ["fact-container"];
            const factTextEl = document.createElement("div");
            factTextEl.classList = ["fact-text"];
            factTextEl.innerHTML = `<span style='font-weight: 800;font-size: 14px'>#fact:</span> ${fact}`;
            factContainerEl.appendChild(factTextEl);
            dinosaurContainerEl.appendChild(factContainerEl);
        }

        dinosaurContainerEl.addEventListener("mouseenter", () => {
            dinosaurContainerEl.style.transition = "background-color 0.6s ease";
            dinosaurContainerEl.style.backgroundColor = 'rgb(255,255,255,0.7)';
            imageEl.style.transition = "left 0.6s ease, opacity 0.6s ease";
            imageEl.style.left = '-100px';
            imageEl.style.opacity = '0.2';
            dinosaurDataContainerEl.style.transition = "display 0.6s ease";
            dinosaurDataContainerEl.style.display = "block";
        });

        dinosaurContainerEl.addEventListener("mouseleave", () => {
            dinosaurContainerEl.style.backgroundColor = color;
            dinosaurDataContainerEl.style.display = "none";
            imageEl.style.left = '54px';
            imageEl.style.opacity = '1';
        });
        return dinosaurContainerEl;
    }

    return { create }
})();


(async function () {
    const { "Dinos": dinoData = [] } = await getDinoData();
    const dinosaurs = dinoData.map(({ species, facts, weight, diet, height }) => new Dinosaur(species, facts, height, weight, diet));
    const tilesFactory = (({ dinosaurs, humanConfig, dinosaurConfigs = [], shuffle }) => {
        const { config: { filename, humanImageUrl = `images/${filename}`, color } } = humanConfig;
        let tiles = [...dinosaurs
            .map(animal => {
                const { config: { color, filename } } = dinosaurConfigs.find(({ species: lookaheadSpecies }) => animal.species === lookaheadSpecies);
                const imageUrl = `images/${filename}`;
                const comparisons = animalDescriptionFactory.getDescription(({ animal, otherAnimals: dinosaurs }));
                return new Tile(animal.species, animal.getFact(), color, imageUrl, comparisons);
            }), new Tile("unnamed human", "", color, humanImageUrl)];

        const byHumanTile = ({ imageUrl }) => "images/human.png" === imageUrl;
        const byDinosaurTile = ({ imageUrl }) => "images/human.png" !== imageUrl;
        const randomizeTiles = () => {
            const humanTile = tiles.find(byHumanTile);
            const randomizableTiles = shuffle(tiles.filter(byDinosaurTile));
            tiles = [...randomizableTiles.slice(0, 4), humanTile, ...randomizableTiles.slice(4, 9)];
        };

        const setHumanTile = ({ tile: newTile }) => {
            tiles = tiles.map(tile => humanImageUrl !== tile.imageUrl ? tile : newTile);
            randomizeTiles();
        };

        const getTiles = () => (tiles);

        randomizeTiles();

        return { getTiles, randomizeTiles, setHumanTile };
    })({ dinosaurs, humanConfig: HUMAN_CONFIG, dinosaurConfigs: DINOSAUR_CONFIGS, shuffle });
    window.addEventListener("load", () => {
        const mainElements = (function () {
            const compareButton = document.getElementById('btn');
            const dinoCompareForm = document.getElementById('dino-compare');
            const nameInput = document.getElementById('name');
            const feetInput = document.getElementById('feet');
            const inchesInput = document.getElementById('inches');
            const weightInput = document.getElementById('weight');
            const dietDropDown = document.getElementById('diet');
            const grid = document.getElementById('grid');

            return {
                compareButton,
                dinoCompareForm,
                nameInput,
                feetInput,
                inchesInput,
                weightInput,
                dietDropDown,
                grid
            }
        })();

        mainElements.compareButton.addEventListener('click', () => {
            const { value: nameText } = mainElements.nameInput;
            const { value: inchesText } = mainElements.inchesInput;
            const { value: feetText } = mainElements.feetInput;
            const { value: lbsText } = mainElements.weightInput;
            const { options: dietOptions, value: dietSelectedValue } = mainElements.dietDropDown;
            const dietText = Array.from(dietOptions).find(({ value }) => dietSelectedValue === value).innerHTML
            const requiredFields = [
                nameText,
                inchesText,
                feetText,
                lbsText,
                dietSelectedValue
            ];

            const everyFieldWasFilled = requiredFields.every((value) => 'string' === typeof value && 0 !== value.length);

            if (!everyFieldWasFilled) {
                alert('please fill all fields')
                return;
            }

            const inches = parseFloat(inchesText);
            const lbs = parseFloat(lbsText);
            const human = new Human("Human", "no facts", inches, lbs, dietText, nameText);
            const { config: { filename, humanImageUrl = `images/${filename}`, color } } = HUMAN_CONFIG;
            const comparisons = animalDescriptionFactory.getDescription({
                animal: human,
                otherAnimals: [...dinosaurs, human]
            });
            const humanTile = new Tile(human.name, human.fact, color, humanImageUrl, comparisons);
            tilesFactory.setHumanTile({ tile: humanTile });
            const tilesEls = tilesFactory
                .getTiles()
                .map((tile) => tileFactory.create(tile));
            tilesEls.forEach(tile => mainElements.grid.appendChild(tile));
            mainElements.dinoCompareForm.style = "display:none";
        });

        mainElements.inchesInput.addEventListener('keyup', () => {
            const { inchesInput: { value: inches } = {} } = mainElements;
            mainElements.feetInput.value = convertInchesToFoot(inches);
        });

        mainElements.feetInput.addEventListener('keyup', () => {
            const { feetInput: { value: feet } = {} } = mainElements;
            mainElements.inchesInput.value = convertFootToInches(feet);
        });
    });
})();

if (typeof window === 'undefined') {
    module.exports = {
        getDinoData,
        convertInchesToFoot,
        convertFootToInches,
        shuffle,
        animalDescriptionFactory,
        Tile,
        Animal,
        Dinosaur,
        Human,
    }
}